---
title: "Figure Reproduction for Scientific Reports Paper 24829"  
author: "Joel R Pradines"
date: "`r Sys.Date()`"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
options(java.parameters = "-Xmx8000m")
library(ggplot2)
library(patchwork)
library(scales)
library(rJava)
.jinit(classpath = "target/classes")
```

## Figure 1

```{r figure_1_data, echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
# Data
 .jcall("heparansulfate/HIModel", "V", "hepI", "input/", "output/HI/")
 .jcall("heparansulfate/HIModel", "V", "hepIII", "input/", "output/HI/")
```

Figure 1. Distributions of fragment lengths $l$ in heparinase digests (crosses) as compared to distributions
expected under model H&I (dots). Relative abundances are summed for $l ≥ 11$ (heparinase I, (a)) and for $l ≥ 6$
(heparinase III, (b)).

```{r figure1_plot, echo=TRUE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
# Plot
plot_figure1_panel <- function(exp_file, model_file, title, threshold, is_hepI = FALSE) {
  
  df_exp <- read.table(exp_file, header = TRUE)
  df_mod <- read.table(model_file, header = TRUE)
  df_combined <- merge(df_exp, df_mod, by = "l")
  
  all_vals <- c(df_combined$f, df_combined$h)
  y_min <- min(all_vals[all_vals > 0]) # Avoid log(0)
  y_max <- max(all_vals)
  
  x_labels <- c(as.character(1:(threshold-1)), paste0("≥", threshold))
  
  p <- ggplot(df_combined, aes(x = factor(l))) +
    geom_point(aes(y = f, shape = "Experimental"), size = 5, stroke = 1) +
    geom_point(aes(y = h, shape = "Model H&I"), size = 5, stroke = 1) +
    
    scale_shape_manual(name = "", values = c("Experimental" = 4, "Model H&I" = 1)) +
    scale_x_discrete(labels = x_labels) +
    labs(title = title, x = "Fragment Length l", y = "Relative Abundance (log scale)") +
    theme_bw() +
    theme(
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 1),        
      axis.title = element_text(size = 14),       
      plot.title = element_text(size = 16, face = "bold"), 
      legend.text = element_text(size = 12)       
    )

  if (is_hepI) {
    p <- p + scale_y_log10(
      limits = c(0.02, 0.5),
      breaks = c(0.05, 0.1, 0.2, 0.5),
      labels = c("0.05", "0.1", "0.2", "0.5")
    )
  } else {
    p <- p + scale_y_log10(
      limits = c(y_min * 0.8, y_max * 1.2),
      breaks = scales::log_breaks(n = 5)
    )
  }
  
  return(p)
}

file_exp_hepI <- "input/hepI.f.txt"
file_HIM_hepI <- "output/HI/HIM.hepIhl.res"
file_exp_hepIII <- "input/hepIII.f.txt"
file_HIM_hepIII <- "output/HI/HIM.hepIIIhl.res"

p1 <- plot_figure1_panel(file_exp_hepI, file_HIM_hepI, "(a) Heparinase I", 11, is_hepI = TRUE)
p2 <- plot_figure1_panel(file_exp_hepIII, file_HIM_hepIII, "(b) Heparinase III", 6, is_hepI = FALSE)

p1 + p2
```

## Figure 2

Figure 2. Model H&C. Distributions of fragment lengths l in heparinases I (a) and III (b) digests (crosses) as
compared to distributions expected under model H&C (dots). Modeling results are summarized for 100 runs
of optimization with different initial conditions. Transition probabilities of homogeneous Markov models for
H&C (c) and H&I (d).

```{r figure_2_data, echo=TRUE, message=FALSE, warning=FALSE, results='hide', eval=FALSE}
# Data
args <- .jarray(character(0), "[Ljava/lang/String;")
 .jcall("heparansulfate/HCModelSA", "V", "main", args)
```

```{r figure2_plot, echo=TRUE, message=FALSE, warning=FALSE, fig.width=12, fig.height=10}
# Plot
read_and_aggregate_hc_fit <- function(folder_path, pattern) {
  files <- list.files(path = folder_path, pattern = pattern, full.names = TRUE)
  
  if (length(files) == 0) {
     warning(paste("No files found for pattern:", pattern))
     return(data.frame(l=1:10, hmod_mean=runif(10,0.01,0.2), hmod_min=0, hmod_max=0.3, fexp=runif(10,0.01,0.2)))
  }
  
  data_list <- lapply(files, read.table, header = TRUE)
  df_all <- do.call(rbind, data_list)
  
  stats_agg <- aggregate(hmod ~ l, data = df_all, function(x) c(mean = mean(x), min = min(x), max = max(x)))
  
  df_res <- data.frame(
    l = stats_agg$l,
    hmod_mean = stats_agg$hmod[, "mean"],
    hmod_min  = stats_agg$hmod[, "min"],
    hmod_max  = stats_agg$hmod[, "max"]
  )
  
  df_exp <- data_list[[1]][, c("l", "fexp")]
  merge(df_res, df_exp, by = "l")
}

get_hc_matrix <- function(folder_path) {
  files <- list.files(path = folder_path, pattern = "MM\\.s[0-9]+\\.P\\.res", full.names = TRUE)
  
  if (length(files) > 0) {
    tables <- lapply(files, function(f) {
      d <- read.table(f, header = TRUE, col.names = c("prev", "nxt", "p"))
      d$prev <- toupper(d$prev); d$nxt <- toupper(d$nxt)
      return(d)
    })
    
    df_all <- do.call(rbind, tables)
    df_agg <- aggregate(p ~ prev + nxt, data = df_all, mean)
    
    get_p <- function(prev, nxt) {
      val <- df_agg$p[df_agg$prev == prev & df_agg$nxt == nxt]
      if (length(val) == 0) 0 else val
    }
    
    matrix(c(get_p("U","U"), get_p("U","S"), get_p("S","U"), get_p("S","S")), nrow=2, byrow=TRUE)
  } else {
    matrix(c(0.53, 0.47, 0.14, 0.86), nrow=2, byrow=TRUE)
  }
}

get_hi_matrix <- function(file_path = "input/US.ab.txt") {
  if (file.exists(file_path)) {
    df <- read.table(file_path, header = TRUE)
    p_u <- df$rho[toupper(df$name) == "U"]; p_s <- df$rho[toupper(df$name) == "S"]
    
    if (length(p_u) == 0) p_u <- 0; if (length(p_s) == 0) p_s <- 0
    
    matrix(c(p_u, p_s, p_u, p_s), nrow=2, byrow=TRUE) 
  } else {
    matrix(c(0.8642, 0.1358, 0.8642, 0.1358), nrow=2, byrow=TRUE)
  }
}

plot_hc_fit_panel <- function(df, title, threshold) {
  x_labs <- as.character(df$l)
  if (max(df$l) == threshold) x_labs[length(x_labs)] <- paste0("≥", threshold)
  
  ggplot(df, aes(x = factor(l))) +
    geom_errorbar(aes(ymin = hmod_min, ymax = hmod_max), width = 0.6) +
    geom_point(aes(y = fexp, shape = "Experimental"), size = 5, stroke = 1) +
    geom_point(aes(y = hmod_mean, shape = "Model H&C"), size = 5, stroke = 1) +
    scale_y_log10() +
    scale_shape_manual(name = "", values = c("Experimental" = 4, "Model H&C" = 1)) +
    scale_x_discrete(labels = x_labs) +
    labs(title = title, x = "Fragment Length l", y = "Relative Abundance (log scale)") +
    theme_bw() +
    theme(
      legend.position = "bottom",
      legend.text = element_text(size = 14),      
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 14),        
      axis.title = element_text(size = 16),       
      plot.title = element_text(size = 18, face = "bold")
    )
}

plot_matrix_heatmap <- function(t_mat, title) {
   df_mat <- data.frame(
    Prev = rep(c("U", "S"), each = 2),
    Next = rep(c("U", "S"), times = 2),
    Prob = as.vector(t(t_mat)) 
  )
  
  df_mat$Prev <- factor(df_mat$Prev, levels = c("S", "U")) 
  df_mat$Next <- factor(df_mat$Next, levels = c("U", "S"))

  ggplot(df_mat, aes(x = Next, y = Prev)) +
    geom_tile(aes(fill = Prob), color = "black", size = 1) +
    geom_text(aes(label = sprintf("%.2f", Prob)), size = 8, fontface = "bold") +
    scale_fill_gradient(low = "white", high = "#6baed6", limits = c(0, 1)) +
    scale_x_discrete(position = "top") + 
    labs(
      title = title,
      x = "Next State", 
      y = "Previous State",
      fill = "Probability"
    ) +
    theme_minimal() +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      axis.text = element_text(size = 14, face = "bold"),    
      axis.title = element_text(size = 16, face = "bold"),  
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b=10)) 
    )
}


folder_hc <- "output/HC/"

df_fit_hepI   <- read_and_aggregate_hc_fit(folder_hc, "HC\\.s[0-9]+\\.hepI\\.fit\\.res")
df_fit_hepIII <- read_and_aggregate_hc_fit(folder_hc, "HC\\.s[0-9]+\\.hepIII\\.fit\\.res")
mat_hc <- get_hc_matrix(folder_hc)
mat_hi <- get_hi_matrix("input/US.ab.txt")

p_a <- plot_hc_fit_panel(df_fit_hepI,   "(a) Heparinase I (Model H&C)", 11)
p_b <- plot_hc_fit_panel(df_fit_hepIII, "(b) Heparinase III (Model H&C)", 6)
p_c <- plot_matrix_heatmap(mat_hc, "(c) Model H&C Transition Matrix")
p_d <- plot_matrix_heatmap(mat_hi, "(d) Model H&I Transition Matrix")

(p_a + p_b) / (p_c + p_d)
```

## Figure 3


Figure 3. Model N&I. Distributions of fragment length l in heparinases I (a) and III (b) digests (crosses) as
compared to distributions expected under model N&I (dots). Optimized profiles of S (c) and U (d) proportions
along chains. Modeling results are summarized for 100 runs of optimization with different initial conditions.

```{r figure_3_data, echo=TRUE, message=FALSE, warning=FALSE, results='hide', eval=FALSE}
# Data
args <- .jarray(character(0), "[Ljava/lang/String;")
 .jcall("heparansulfate/NIModelSA", "V", "main", args)
```

```{r figure_3_plot, echo=TRUE, message=FALSE, warning=FALSE, fig.width=12, fig.height=10}
# Plot
read_ni_fit <- function(folder_path, pattern) {
  files <- list.files(path = folder_path, pattern = pattern, full.names = TRUE)
  
  if (length(files) == 0) {
    warning(paste("No files found for pattern:", pattern))
    return(data.frame(l=1:10, hmod_mean=runif(10,0.01,0.1), hmod_min=0, hmod_max=0.2, fexp=runif(10,0.01,0.1)))
  }
  
  data_list <- lapply(files, read.table, header = TRUE)
  df_all <- do.call(rbind, data_list)
  
  stats <- aggregate(hmod ~ l, data = df_all, function(x) c(mean = mean(x), min = min(x), max = max(x)))
  
  df_res <- data.frame(
    l = stats$l,
    hmod_mean = stats$hmod[, "mean"],
    hmod_min  = stats$hmod[, "min"],
    hmod_max  = stats$hmod[, "max"]
  )
  
  df_exp <- data_list[[1]][, c("l", "fexp")]
  merge(df_res, df_exp, by = "l")
}

read_ni_profiles <- function(folder_path) {
  files <- list.files(path = folder_path, pattern = "PM\\.s[0-9]+\\.gamma\\.res", full.names = TRUE)
  
  if (length(files) == 0) {
    warning("No gamma.res files found.")
    return(data.frame(position=1:16, s_mean=runif(16), s_min=0, s_max=1, u_mean=runif(16), u_min=0, u_max=1))
  }
  
  data_list <- lapply(files, read.table, header = TRUE)
  df_all <- do.call(rbind, data_list)
  
  stats_s <- aggregate(s ~ position, data = df_all, function(x) c(mean = mean(x), min = min(x), max = max(x)))
  
  stats_u <- aggregate(u ~ position, data = df_all, function(x) c(mean = mean(x), min = min(x), max = max(x)))
  
  data.frame(
    position = stats_s$position,
    s_mean = stats_s$s[, "mean"], s_min = stats_s$s[, "min"], s_max = stats_s$s[, "max"],
    u_mean = stats_u$u[, "mean"], u_min = stats_u$u[, "min"], u_max = stats_u$u[, "max"]
  )
}

plot_fit_panel <- function(df, title, threshold) {
  x_labs <- as.character(df$l)
  if (max(df$l) == threshold) x_labs[length(x_labs)] <- paste0("≥", threshold)
  
  ggplot(df, aes(x = factor(l))) +
    geom_errorbar(aes(ymin = hmod_min, ymax = hmod_max), width = 0.6) +
    
    geom_point(aes(y = fexp, shape = "Experimental"), size = 5, stroke = 1) +
    geom_point(aes(y = hmod_mean, shape = "Model N&I"), size = 5) +
    scale_y_log10() +
    scale_shape_manual(name = "", values = c("Experimental" = 4, "Model N&I" = 1)) + 
    scale_x_discrete(labels = x_labs) +
    labs(title = title, x = "Fragment Length l", y = "Relative Abundance (log scale)") +
    theme_bw() +
    theme(legend.position = "bottom", 
          legend.text = element_text(size = 14),
          panel.grid.minor = element_blank(),
          axis.text = element_text(size = 12),        
          axis.title = element_text(size = 14),       
          plot.title = element_text(size = 16, face = "bold"))
          }

plot_profile_panel <- function(df, variable, title) {
  y_mean <- df[[paste0(variable, "_mean")]]
  y_min  <- df[[paste0(variable, "_min")]]
  y_max  <- df[[paste0(variable, "_max")]]
  
  ggplot(df, aes(x = position)) +
    geom_errorbar(aes(ymin = y_min, ymax = y_max), width = 0.6, color = "black") +
    
    geom_line(aes(y = y_mean), color = "black", alpha = 0.6) +
    
    geom_point(aes(y = y_mean), shape = 1, size = 4) +
    
    scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
    scale_x_continuous(breaks = df$position) + 
    labs(title = title, x = "Position along chain", y = "Probability") +
    theme_bw() +
    theme(panel.grid.minor = element_blank(),
          legend.text = element_text(size = 14),
          axis.text = element_text(size = 14),        
          axis.title = element_text(size = 16),       
          plot.title = element_text(size = 18, face = "bold")) 
}


folder_ni <- "output/NI/"

df_fit_hepI   <- read_ni_fit(folder_ni, "PM\\.s[0-9]+\\.hepI\\.fit\\.res")
df_fit_hepIII <- read_ni_fit(folder_ni, "PM\\.s[0-9]+\\.hepIII\\.fit\\.res")
df_profiles   <- read_ni_profiles(folder_ni)

p_a <- plot_fit_panel(df_fit_hepI,   "(a) Heparinase I (Model N&I)", 11)
p_b <- plot_fit_panel(df_fit_hepIII, "(b) Heparinase III (Model N&I)", 6)
p_c <- plot_profile_panel(df_profiles, "s", "(c) Profile of S proportions")
p_d <- plot_profile_panel(df_profiles, "u", "(d) Profile of U proportions")

(p_a + p_b) / (p_c + p_d)
```

## Figure 4

Figure 4. Infeasibility of constraint sets as a function of BKHS chain length n. Dots: constraints of
heparinase digests and overall disaccharide composition. Crosses: constraints of heparinase digests and
homogeneity.

```{r figure_4_data, echo=TRUE, message=FALSE, warning=FALSE, results='hide', eval=FALSE}
# Data
args <- .jarray(character(0), "[Ljava/lang/String;")
.jcall("heparansulfate/ProfileFeasibility", "V", "main", args)
.jcall("heparansulfate/HomogeneityFeasibility", "V", "main", args)
```

```{r figure_4_plot, echo=TRUE, message=FALSE, warning=FALSE, fig.width=7, fig.height=5}
# Plot
file_feas <- "output/LP/Feasibility.res"
file_hom  <- "output/LP/HomogeneityFeasibility.res"

df_comp <- read.table(file_feas, header = TRUE, sep = "\t")
df_comp$Dataset <- "Overall composition"

df_hom <- read.table(file_hom, header = TRUE, sep = "\t")
df_hom$Dataset <- "Homogeneity"

df_all <- rbind(df_comp, df_hom)

ggplot(df_all, aes(x = n, y = infeasibility)) +
  geom_line(aes(group = Dataset), color = "gray", size = 0.5) +  
  geom_point(aes(shape = Dataset), size = 4, stroke = 1) +
  scale_y_log10(breaks = 10^seq(0, -16, by = -4), 
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  scale_shape_manual(name = "", 
                     values = c("Overall composition" = 1, "Homogeneity" = 4)) +
  
  labs(x = "BKHS chain length n", y = "Infeasibility") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 14),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 14),        
    axis.title = element_text(size = 16),       
    plot.title = element_text(size = 18, face = "bold")
  )
```

## Figure 5

Figure 5. (a,b) Maximum-entropy estimates of S and U composition along BKHS chains (circles) and lower and upper bounds at each position estimated via linear programming (squares). Horizontal lines display overall S and U proportions. (c,d) Profiles of transition probabilities between disaccharides along chains, as estimated with maximum-entropy modeling (black symbols) and compared to the profile of disaccharide composition
along chains (white symbols).

```{r figure_5_data, echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
# Data
.jcall("heparansulfate/MaxEntModel", "V", "defaultModel", "input/", "output/ME/")
.jcall("heparansulfate/GradientWidth", "V", "bounds", "input/", "output/ME/")
```

```{r figure_5_complete, echo=TRUE, message=FALSE, warning=FALSE, fig.width=12, fig.height=10}
# Plot
gamma_file <- "output/ME/MEM.gamma.res"
pt_file    <- "output/ME/MEM.pt.res"
ab_file    <- "input/US.ab.txt"
gw_file    <- "output/ME/GradientWidth.res"

df_gamma <- read.table(gamma_file, header = TRUE, sep = "\t")

df_pt <- read.table(pt_file, header = TRUE, sep = "\t")

df_ab <- read.table(ab_file, header = TRUE, sep = "\t")
rho_S <- df_ab$rho[df_ab$name == "s" | df_ab$name == "S"]
rho_U <- df_ab$rho[df_ab$name == "u" | df_ab$name == "U"]

df_gw <- read.table(gw_file, header = TRUE, sep = "\t")


p_a <- ggplot() +
  geom_hline(yintercept = rho_S, linetype = "solid", color = "black") +
  geom_segment(data = df_gw, aes(x = pos, xend = pos, y = lowerU, yend = upperU),
               linetype = "dotted", size = 0.5, color = "black") +
  geom_point(data = df_gw, aes(x = pos, y = lowerU), shape = 15, size = 3, color = "black") +
  geom_point(data = df_gw, aes(x = pos, y = upperU), shape = 15, size = 3, color = "black") +
  geom_point(data = df_gamma, aes(x = pos, y = s), shape = 1, size = 4, stroke = 1.2, color = "black") +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_gamma$pos), 1)) +
  labs(title = "(a) S", x = "Position from non-reducing end", y = "Proportion") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
        axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        panel.grid.minor = element_blank())



p_b <- ggplot() +
  geom_hline(yintercept = rho_U, linetype = "solid", color = "black") +
  geom_segment(data = df_gw, aes(x = pos, xend = pos, y = lowerS, yend = upperS),
               linetype = "dotted", size = 0.5, color = "black") +
  geom_point(data = df_gw, aes(x = pos, y = lowerS), shape = 15, size = 3, color = "black") +
  geom_point(data = df_gw, aes(x = pos, y = upperS), shape = 15, size = 3, color = "black") +
  geom_point(data = df_gamma, aes(x = pos, y = u), shape = 1, size = 4, stroke = 1.2, color = "black") +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_gamma$pos), 1)) +
  labs(title = "(b) U", x = "Position from non-reducing end", y = "Proportion") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
        axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        panel.grid.minor = element_blank())


p_c <- ggplot() +
  geom_line(data = df_gamma, aes(x = pos, y = s), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = s), shape = 0, size = 4, color = "gray", stroke = 1) +
  geom_line(data = df_gamma, aes(x = pos, y = u), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = u), shape = 1, size = 4, color = "gray", stroke = 1) +

  geom_line(data = df_pt, aes(x = pos, y = pus), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = pus), shape = 15, size = 4, color = "black") +
  geom_line(data = df_pt, aes(x = pos, y = puu), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = puu), shape = 16, size = 4, color = "black") +
  
  annotate("point", x = 10, y = 0.75, shape = 16, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.75, label = "from U to U", hjust = 0, size = 4) +
  annotate("point", x = 10, y = 0.20, shape = 15, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.20, label = "from U to S", hjust = 0, size = 4) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_pt$pos), 1)) +
  labs(title = "(c) Transitions from U", x = "Position from non-reducing end", y = "Probability") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
        axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        panel.grid.minor = element_blank())


p_d <- ggplot() +
  geom_line(data = df_gamma, aes(x = pos, y = s), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = s), shape = 0, size = 4, color = "gray", stroke = 1) +
  geom_line(data = df_gamma, aes(x = pos, y = u), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = u), shape = 1, size = 4, color = "gray", stroke = 1) +

  geom_line(data = df_pt, aes(x = pos, y = pss), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = pss), shape = 15, size = 4, color = "black") +
  geom_line(data = df_pt, aes(x = pos, y = psu), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = psu), shape = 16, size = 4, color = "black") +
  
  annotate("point", x = 10, y = 0.85, shape = 16, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.85, label = "from S to U", hjust = 0, size = 4) +
  annotate("point", x = 10, y = 0.20, shape = 15, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.20, label = "from S to S", hjust = 0, size = 4) +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_pt$pos), 1)) +
  labs(title = "(d) Transitions from S", x = "Position from non-reducing end", y = "Probability") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
        axis.text = element_text(size = 12), axis.title = element_text(size = 14),
        panel.grid.minor = element_blank())

(p_a | p_b) / (p_c | p_d)
```

## Figure 6

Figure 6. (a,b) Two models of BKHS chain length distributions (a) and resulting chain disaccharide composition as a function of their length under maximum-entropy modeling (b). (c-f) Estimations of nonhomogeneity and correlation profiles when BKHS is modeled as a mixture of chain lengths ($10 ≤ n ≤ 20, \sigma
= 3.5)$. Chains are either aligned by their non-reducing end (c,e) or their reducing end (d,f). (c,d) maximum-entropy composition profile (circles), bounds at each position (squares) and overall composition (horizontal line). (e,f) transition probabilities from S to S or U (black) compared to probabilities under independence (white).



```{r figure_6_data_1, echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
# Data, individual species abundances
.jcall("heparansulfate/MaxEntModelW", "V", "makeSig35Filtered", "input/", "output/MEW/")
.jcall("heparansulfate/MaxEntModelW", "V", "makeSig15Filtered", "input/", "output/MEW/")
```

```{r figure_6_data_2, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}
# Data, averages over individual species
.jcall("heparansulfate/MaxEntModelW", "V", "glAndRholAndProfExamplesFiltered", "input/", "output/MEW/")
```
```{r figure_6_data_3, echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
# Data, LP bounds
.jcall("heparansulfate/GradientWidth", "V", "defaultMixSpec", "input/", "output/MEW/")
```

```{r verify_filtering_fixed, echo=TRUE, message=FALSE, warning=FALSE}
verify_files <- function(orig_name, filt_name, dir = "output/MEW/") {
  path_orig <- paste0(dir, orig_name)
  path_filt <- paste0(dir, filt_name)
  
  if (!file.exists(path_orig) | !file.exists(path_filt)) {
    return(data.frame(File = orig_name, Max_Error = NA, Status = "Missing"))
  }
  
  df_o <- read.table(path_orig, header = TRUE, sep = "\t")
  df_f <- read.table(path_filt, header = TRUE, sep = "\t")
  
  # Check if dimensions match
  if (nrow(df_o) != nrow(df_f) | ncol(df_o) != ncol(df_f)) {
    return(data.frame(File = orig_name, Max_Error = NA, Status = "Dim Mismatch"))
  }
  
  # Identify numeric columns for comparison (excluding the index/pos columns)
  # We assume the first column is always the position/index
  cols_to_compare <- names(df_o)[sapply(df_o, is.numeric)][-1]
  
  if (length(cols_to_compare) == 0) {
     return(data.frame(File = orig_name, Max_Error = NA, Status = "No Numeric Data"))
  }

  # Calculate differences
  diffs <- abs(as.matrix(df_o[, cols_to_compare]) - as.matrix(df_f[, cols_to_compare]))
  max_err <- max(diffs, na.rm = TRUE)
  
  return(data.frame(File = orig_name, Max_Error = max_err, Status = "OK"))
}

# Define the pairs
pairs <- list(
  c("MEMW.prof.res", "MEMWF.prof.res"),
  c("MEMW.ptnre.res", "MEMWF.ptnre.res"),
  c("MEMW.ptre.res", "MEMWF.ptre.res"),
  c("MEMW.rhol.res", "MEMWF.rhol.res"),
  c("MEMWSig1.5.prof.res", "MEMWSig1.5F.prof.res"),
  c("MEMWSig1.5.ptnre.res", "MEMWSig1.5F.ptnre.res"),
  c("MEMWSig1.5.ptre.res", "MEMWSig1.5F.ptre.res"),
  c("MEMWSig1.5.rhol.res", "MEMWSig1.5F.rhol.res")
)

# Run Comparison
results_list <- lapply(pairs, function(p) verify_files(p[1], p[2]))
comparison_results <- do.call(rbind, results_list)
print(comparison_results)
```

```{r stop_knit, echo=FALSE}
##########################
knitr::knit_exit()
##########################
```

```{r figure_6a, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

# 1. Read Data
# Using the filtered results as they are identical to the original full files for these stats
file_35 <- "output/MEW/MEMWF.rhol.res"
file_15 <- "output/MEW/MEMWSig1.5F.rhol.res"

df_35 <- read.table(file_35, header = TRUE, sep = "\t")
df_35$Model <- "sigma = 3.5"

df_15 <- read.table(file_15, header = TRUE, sep = "\t")
df_15$Model <- "sigma = 1.5"

# Combine for plotting
df_all <- rbind(df_35, df_15)

# 2. Plot Panel (a)
ggplot(df_all, aes(x = l, y = w, group = Model, shape = Model)) +
  # Thin black line linking points
  geom_line(size = 0.5, color = "black") +
  
  # Points with specific shapes
  # shape 21 = open circle (can have fill), shape 4 = cross
  geom_point(aes(fill = Model), size = 3, color = "black", stroke = 1) +
  
  # Manual scale to set shapes and ensure circle is white
  scale_shape_manual(values = c("sigma = 3.5" = 21, "sigma = 1.5" = 4)) +
  scale_fill_manual(values = c("sigma = 3.5" = "white", "sigma = 1.5" = "black")) +
  
  # Scales and Labels
  scale_x_continuous(breaks = seq(10, 20, 1), limits = c(10, 20)) +
  scale_y_continuous(limits = c(0, 0.25)) +
  labs(title = "(a)", x = "Chain length", y = "Proportion of chains") +
  
  # Theme
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none", # Legend usually omitted or shared in final patchwork
    panel.grid.minor = element_blank()
  )
```

``{r figure_6b, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

# 1. Read Data
# (Same logic as panel a)
file_35 <- "output/MEW/MEMWF.rhol.res"
file_15 <- "output/MEW/MEMWSig1.5F.rhol.res"

df_35 <- read.table(file_35, header = TRUE, sep = "\t")
df_35$Model <- "sigma = 3.5"

df_15 <- read.table(file_15, header = TRUE, sep = "\t")
df_15$Model <- "sigma = 1.5"

df_all <- rbind(df_35, df_15)

# 2. Plot Panel (b)
ggplot(df_all, aes(x = l, y = rhoS, group = Model, shape = Model)) +
  # Thin black line linking points
  geom_line(size = 0.5, color = "black") +
  
  # Points: Shape 21 (Circle with fill) and Shape 4 (Cross)
  geom_point(aes(fill = Model), size = 3, color = "black", stroke = 1) +
  
  # Styling markers
  scale_shape_manual(values = c("sigma = 3.5" = 21, "sigma = 1.5" = 4)) +
  scale_fill_manual(values = c("sigma = 3.5" = "white", "sigma = 1.5" = "black")) +
  
  # Scales and Labels
  scale_x_continuous(breaks = seq(10, 20, 1), limits = c(10, 20)) +
  # S proportions usually reside in the 0.8+ range for this data
  scale_y_continuous(limits = c(0.8, 0.9)) + 
  labs(title = "(b)", x = "Chain length", y = "Proportion of S") +
  
  # Theme
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

```{r figure_6c, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

# 1. Read Data
prof_file <- "output/MEW/MEMWF.prof.res"
ab_file   <- "input/US.ab.txt"

df_prof <- read.table(prof_file, header = TRUE, sep = "\t")

# Overall Abundance for horizontal line
df_ab <- read.table(ab_file, header = TRUE, sep = "\t")
rho_S <- df_ab$rho[df_ab$name == "s" | df_ab$name == "S"]

# 2. Prepare Aesthetics
# Borders are black for pos <= 10 and gray for pos > 10
df_prof$border_color <- ifelse(df_prof$nrePos <= 10, "black", "gray")

# 3. Plot Panel (c)
ggplot(df_prof, aes(x = nrePos, y = pnreS)) +
  # Overall S proportion (Solid Horizontal line)
  geom_hline(yintercept = rho_S, linetype = "solid", color = "black") +
  
  # Thin black line linking points
  geom_line(size = 0.5, color = "black") +
  
  # Points: White circles with conditional border colors
  # shape 21 allows for separate stroke (color) and fill
  geom_point(aes(color = border_color), shape = 21, fill = "white", 
             size = 4, stroke = 1.2) +
  
  # Map colors manually
  scale_color_identity() +
  
  # Scales and Labels
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, 20, 1)) +
  labs(title = "(c) aligned by non-reducing end", 
       x = "Position from non-reducing end", 
       y = "Proportion of S") +
  
  # Theme
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```

```{r figure_6d, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

# 1. Read Data
prof_file <- "output/MEW/MEMWF.prof.res"
ab_file   <- "input/US.ab.txt"

df_prof <- read.table(prof_file, header = TRUE, sep = "\t")

# Overall Abundance for horizontal line
df_ab <- read.table(ab_file, header = TRUE, sep = "\t")
rho_S <- df_ab$rho[df_ab$name == "s" | df_ab$name == "S"]

# 2. Prepare Aesthetics for (d)
# The first 10 positions (nrePos 1:10) are far from the reducing end -> gray borders
# The last 10 positions (nrePos 11:20) are close to the reducing end -> black borders
df_prof$border_color_d <- ifelse(df_prof$nrePos <= 10, "gray", "black")

# 3. Plot Panel (d)
ggplot(df_prof, aes(x = nrePos, y = preS)) +
  # Overall S proportion (Solid Horizontal line)
  geom_hline(yintercept = rho_S, linetype = "solid", color = "black") +
  
  # Thin black line linking points
  geom_line(size = 0.5, color = "black") +
  
  # Points: preS values with conditional border colors
  geom_point(aes(color = border_color_d), shape = 21, fill = "white", 
             size = 4, stroke = 1.2) +
  
  # Map colors manually
  scale_color_identity() +
  
  # Scales and Labels (X-axis stays nrePos 1-20)
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, 20, 1)) +
  labs(title = "(d) aligned by reducing end", 
       x = "Position from non-reducing end", 
       y = "Proportion of S") +
  
  # Theme
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```



























```{r figure_5a_final, echo=TRUE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

gamma_file <- "output/ME/MEM.gamma.res"
ab_file    <- "input/US.ab.txt"
gw_file    <- "output/ME/GradientWidth.res"

df_gamma <- read.table(gamma_file, header = TRUE, sep = "\t")

df_ab <- read.table(ab_file, header = TRUE, sep = "\t")
rho_S <- df_ab$rho[df_ab$name == "s" | df_ab$name == "S"]

df_gw <- read.table(gw_file, header = TRUE, sep = "\t")

ggplot() +
  geom_hline(yintercept = rho_S, linetype = "solid", color = "black") +
  
  geom_segment(data = df_gw, aes(x = pos, xend = pos, y = lowerS, yend = upperS),
               linetype = "dotted", size = 0.5, color = "black") +
  
  geom_point(data = df_gw, aes(x = pos, y = lowerS), 
             shape = 15, size = 3, color = "black") +
  
  geom_point(data = df_gw, aes(x = pos, y = upperS), 
             shape = 15, size = 3, color = "black") +
  
  geom_point(data = df_gamma, aes(x = pos, y = s), 
             shape = 1, size = 4, stroke = 1.2, color = "black") +
  
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_gamma$pos), 1)) +
  labs(title = "(a) S", x = "Position from non-reducing end", y = "Proportion") +
  
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```

```{r figure_5b, echo=TRUE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

gamma_file <- "output/ME/MEM.gamma.res"
ab_file    <- "input/US.ab.txt"
gw_file    <- "output/ME/GradientWidth.res"

df_gamma <- read.table(gamma_file, header = TRUE, sep = "\t")

df_ab <- read.table(ab_file, header = TRUE, sep = "\t")
rho_U <- df_ab$rho[df_ab$name == "u" | df_ab$name == "U"]

df_gw <- read.table(gw_file, header = TRUE, sep = "\t")

ggplot() +
  geom_hline(yintercept = rho_U, linetype = "solid", color = "black") +
  
  geom_segment(data = df_gw, aes(x = pos, xend = pos, y = lowerU, yend = upperU),
               linetype = "dotted", size = 0.5, color = "black") +
  
  geom_point(data = df_gw, aes(x = pos, y = lowerU), 
             shape = 15, size = 3, color = "black") +
  
  geom_point(data = df_gw, aes(x = pos, y = upperU), 
             shape = 15, size = 3, color = "black") +
  
  geom_point(data = df_gamma, aes(x = pos, y = u), 
             shape = 1, size = 4, stroke = 1.2, color = "black") +
  
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_gamma$pos), 1)) +
  labs(title = "(b) U", x = "Position from non-reducing end", y = "Proportion") +
  
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```

```{r figure_5c_final, echo=TRUE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}
library(ggplot2)

pt_file    <- "output/ME/MEM.pt.res"
gamma_file <- "output/ME/MEM.gamma.res"

df_pt <- read.table(pt_file, header = TRUE, sep = "\t")

df_gamma <- read.table(gamma_file, header = TRUE, sep = "\t")

ggplot() +
  
  geom_line(data = df_gamma, aes(x = pos, y = s), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = s), 
             shape = 0, size = 4, color = "gray", stroke = 1) +
  
  geom_line(data = df_gamma, aes(x = pos, y = u), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = u), 
             shape = 1, size = 4, color = "gray", stroke = 1) +
  
  geom_line(data = df_pt, aes(x = pos, y = pus), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = pus), 
             shape = 15, size = 4, color = "black") +
  
  geom_line(data = df_pt, aes(x = pos, y = puu), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = puu), 
             shape = 16, size = 4, color = "black") +

  annotate("point", x = 10, y = 0.75, shape = 16, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.75, label = "from U to U", hjust = 0, size = 4) +
  
  annotate("point", x = 10, y = 0.20, shape = 15, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.20, label = "from U to S", hjust = 0, size = 4) +

  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_pt$pos), 1)) +
  labs(title = "(c) Transitions from U", 
       x = "Position from non-reducing end", 
       y = "Probability") +
  
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```

```{r figure_5d, echo=TRUE, message=FALSE, warning=FALSE, fig.width=6, fig.height=5}

pt_file    <- "output/ME/MEM.pt.res"
gamma_file <- "output/ME/MEM.gamma.res"
df_pt <- read.table(pt_file, header = TRUE, sep = "\t")
df_gamma <- read.table(gamma_file, header = TRUE, sep = "\t")

ggplot() +
  geom_line(data = df_gamma, aes(x = pos, y = s), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = s), 
             shape = 0, size = 4, color = "gray", stroke = 1) +
  geom_line(data = df_gamma, aes(x = pos, y = u), color = "gray", size = 0.5) +
  geom_point(data = df_gamma, aes(x = pos, y = u), 
             shape = 1, size = 4, color = "gray", stroke = 1) +

  geom_line(data = df_pt, aes(x = pos, y = pss), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = pss), 
             shape = 15, size = 4, color = "black") +
  geom_line(data = df_pt, aes(x = pos, y = psu), color = "black", size = 0.5) +
  geom_point(data = df_pt, aes(x = pos, y = psu), 
             shape = 16, size = 4, color = "black") +
  
  annotate("point", x = 10, y = 0.9, shape = 16, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.9, label = "from S to U", hjust = 0, size = 4) +
  
  annotate("point", x = 10, y = 0.15, shape = 15, size = 4, color = "black") +
  annotate("text",  x = 10.5, y = 0.15, label = "from S to S", hjust = 0, size = 4) +

  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(breaks = seq(1, max(df_pt$pos), 1)) +
  labs(title = "(d) Transitions from S", 
       x = "Position from non-reducing end", 
       y = "Probability") +
  
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    panel.grid.minor = element_blank()
  )
```