---
title: "Figure Reproduction for Scientific Reports Paper 24829"  
author: "Joel R Pradines"
date: "`r Sys.Date()`"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(patchwork)
library(rJava)
.jinit(classpath = "target/classes")
```

## Figure 1

```{r figure1, echo=TRUE, message=FALSE, warning=FALSE}
# Generating figure data
.jcall("heparansulfate/HIModel", "V", "hepI", "input/", "output/HIM/")
.jcall("heparansulfate/HIModel", "V", "hepIII", "input/", "output/HIM/")
```

Figure 1. Distributions of fragment lengths $l$ in heparinase digests (crosses) as compared to distributions
expected under model H&I (dots). Relative abundances are summed for $l ≥ 11$ (heparinase I, (a)) and for $l ≥ 6$
(heparinase III, (b)).

```{r figure1_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}

plot_figure1_panel <- function(exp_file, model_file, title, threshold, is_hepI = FALSE) {
  # 1. Load and Merge
  df_exp <- read.table(exp_file, header = TRUE)
  df_mod <- read.table(model_file, header = TRUE)
  df_combined <- merge(df_exp, df_mod, by = "l")
  
  # 2. Determine Scale Limits for Panel (b) or use specific for Panel (a)
  # We calculate the range of all data to ensure nothing is cut off
  all_vals <- c(df_combined$f, df_combined$h)
  y_min <- min(all_vals[all_vals > 0]) # Avoid log(0)
  y_max <- max(all_vals)
  
  # 3. Define Labels
  x_labels <- c(as.character(1:(threshold-1)), paste0("≥", threshold))
  
  p <- ggplot(df_combined, aes(x = factor(l))) +
    # Crosses: wider using size=4 and stroke=1.5
    geom_point(aes(y = f, shape = "Experimental"), size = 4, stroke = 1.5) +
    # Open Circles: wider using size=4 and stroke=1.5
    geom_point(aes(y = h, shape = "Model H&I"), size = 4, stroke = 1.5) +
    
    scale_shape_manual(name = "", values = c("Experimental" = 4, "Model H&I" = 1)) +
    scale_x_discrete(labels = x_labels) +
    theme_bw() +
    labs(title = title, x = "Fragment Length l", y = "Relative Abundance") +
    theme(
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 10)
    )

  # 4. Apply Specific Y-Axis Logic
  if (is_hepI) {
    # Panel (a) specific: 0.05, 0.1, 0.2, 0.5
    p <- p + scale_y_log10(
      limits = c(0.02, 0.5),
      breaks = c(0.05, 0.1, 0.2, 0.5),
      labels = c("0.05", "0.1", "0.2", "0.5")
    )
  } else {
    # Panel (b) auto-scale: Ensure everything fits
    # We add a small buffer (0.8 and 1.2) to the min/max
    p <- p + scale_y_log10(
      limits = c(y_min * 0.8, y_max * 1.2),
      breaks = scales::log_breaks(n = 5)
    )
  }
  
  return(p)
}

# File paths
file_exp_hepI <- "input/hepI.f.txt"
file_HIM_hepI <- "output/HIM/HIM.hepIhl.res"
file_exp_hepIII <- "input/hepIII.f.txt"
file_HIM_hepIII <- "output/HIM/HIM.hepIIIhl.res"

# Generate Panels
p1 <- plot_figure1_panel(file_exp_hepI, file_HIM_hepI, "(a) Heparinase I", 11, is_hepI = TRUE)
p2 <- plot_figure1_panel(file_exp_hepIII, file_HIM_hepIII, "(b) Heparinase III", 6, is_hepI = FALSE)

p1 + p2
```

## Figure 2

Figure 2. Model H&C. Distributions of fragment lengths l in heparinases I (a) and III (b) digests (crosses) as
compared to distributions expected under model H&C (dots). Modeling results are summarized for 100 runs
of optimization with different initial conditions. Transition probabilities of homogeneous Markov models for
H&C (c) and H&I (d).

```{r figure2, echo=TRUE, message=FALSE, warning=FALSE}
args <- .jarray(character(0), "[Ljava/lang/String;")
# Generating figure data
 .jcall("heparansulfate/HCModelSA", "V", "main", args)
```